
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <script
    type="text/javascript"
    src="/js/lib/dummy.js"
    
  ></script>

    <link rel="stylesheet" type="text/css" href="/css/result-light.css">


  <style id="compiled-css" type="text/css">
        center center {
  font-family: sans-serif;
  font-size: 0.8em;
}

table, td {
  //border: 1px solid;
  border-collapse: collapse;
  
	padding: 3px;
}

table {
  //table-layout: fixed;
  width: 100%;
  max-width: 290px;
}



table tr:nth-child(even) tr, table tr:nth-child(even) {
  background-color: #FFA;
}

tr td:nth-child(3) {
  font-weight: bold;
}

input {
  display: block;
}

    /* EOS */
  </style>

  <script id="insert"></script>

</head>
<body>
    <center>
  <center>


    <table>
      <tbody id="tbody"></tbody>

    </table>



    <br>
    <small>https://jsfiddle.net/schweissguth/6y9wroq7/</small>
    <br>
    <footer>
      <details>
        <summary>Info</summary>

        Date: <input type="date" id="inpdate" onchange="getCurrentRace()">
        Race date: <input type="text" id="outputraceday" disabled>
        Race id: <input type="text" id="outputraceid" disabled>
        Track: <input type="text" id="outputrace" disabled>
      </details>
    </footer>
  </center>
</center>


    <script type="text/javascript">//<![CDATA[


var SS = "1jwadkJYYfBmf-SbjUokDV0S_yzC7gD39-jHxVatJfLU"

var ARR = []
var RACESCHEDULE = []
var TODAY = Date.now()
var RACEID = 0
var RESULTS = []
var PICKS = []
var PLAYERS = []



function init() {
  inpdate.valueAsDate = new Date()
  getRaceSchedule()
}

init()

function getRaceSchedule() {
  fetch("https://cf.nascar.com/cacher/2023/race_list_basic.json").then(function(x) {
    return x.json()
  }).then(function(item) {
    RACESCHEDULE = item.series_1.reverse()
    getCurrentRace()
  })
}

function getCurrentRace() {
	tbody.innerHTML = ""
  var todaydate = new Date(inpdate.value + "T00:00:00-06:00")
  var todaytime = todaydate.getTime()
  console.log(todaytime)

  var race = RACESCHEDULE.find(function(item) {
    var datestr = new Date(item.date_scheduled).toLocaleDateString()
    var gettime = new Date(datestr).getTime()
    console.log(todaytime - gettime)
    return gettime < todaytime
  })

  outputraceid.value = race.race_id
  RACEID = race.race_id
  outputraceday.value = new Date(race.date_scheduled)
  outputrace.value = race.track_name

  getResults()
}


function getResults() {
  fetch("https://cf.nascar.com/live/feeds/series_1/" + RACEID + "/live_feed.json").then(function(item) {
    return item.json()
  }).then(function(item) {
    RESULTS = item
    console.log("RESULTS", RESULTS)
    getPicks()
  })
}



function getPicks() {
  fetch("https://script.google.com/macros/s/AKfycbxDPpq6qUSoeom_c7U89UEUmZFiMi0WamcpAXgBgoVspm47I3HmwicaiUdpNzGnBlC_jw/exec?ss=" + SS + "&s=PICKS&pw=randy").then(function(item) {
    return item.json()
  }).then(function(item) {
    console.log("PICKS DATARANGE", item)
    PICKS = item
    filterPicks()
  })
}

function filterPicks() {
	PICKS = PICKS.filter(function(item) {
  	return RACEID == item.RACEID
  })
  console.log("FILTERED", PICKS)
  mapPicks()
}


function mapPicks() {
	PICKS.forEach(function(item) {
  	var split = item.DRIVERID.split("c")[1]
  	var find = RESULTS.vehicles.find(function(jtem) {
    	return jtem.vehicle_number == parseInt(split)
    })
    if (find) {
    	find.data_playerid = item.PLAYERID
      console.log()
    }
  })
  console.log("VEHICLES", RESULTS.vehicles)
  getPlayers()
}


function getPlayers() {
  fetch("https://script.google.com/macros/s/AKfycbxDPpq6qUSoeom_c7U89UEUmZFiMi0WamcpAXgBgoVspm47I3HmwicaiUdpNzGnBlC_jw/exec?ss=" + SS + "&s=PLAYERS&pw=randy").then(function(item) {
    return item.json()
  }).then(function(item) {
    PLAYERS = item.filter(function(jtem) {
    	return jtem.ACTIVE == "TRUE"
    })
    console.log("PLAYERS DATARANGE", PLAYERS)
    mapPlayers()
  })
}

function mapPlayers() {
	console.log("mapping players")
	PLAYERS.forEach(function(item) {
  	RESULTS.vehicles.map(function(jtem) {
    	if (jtem.data_playerid == item.PLAYERID) {
      	jtem.data_playername = item.PLAYERNAME
      }
    })

  })
  console.log("VEHICLES", RESULTS.vehicles)
  buildTable()

}



function buildTable() {
	tbody.innerHTML = ""
  	var count = 22
	RESULTS.vehicles.forEach(function(item, index) {
    var tr = tbody.insertRow()
    tr.insertCell().innerHTML = item.running_position
    tr.insertCell().innerHTML = item.driver.full_name
    tr.insertCell().innerHTML = item.data_playername || ""
    if (item.data_playerid) {
      tr.insertCell().innerHTML = count--
    
    } else {
    
    tr.insertCell().innerHTML = ""
    }
    
  })
}


  //]]></script>

  <script>
    // tell the embed parent frame the height of the content
    if (window.parent && window.parent.parent){
      window.parent.parent.postMessage(["resultsFrame", {
        height: document.body.getBoundingClientRect().height,
        slug: "6y9wroq7"
      }], "*")
    }

    // always overwrite window.name, in case users try to set it manually
    window.name = "result"
  </script>


</body>
</html>
