
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>STUPID-FAST FLAG DATA</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <script
    type="text/javascript"
    src="/js/lib/dummy.js"
    
  ></script>

    <link rel="stylesheet" type="text/css" href="/css/result-light.css">


  <style id="compiled-css" type="text/css">
    center center {
  font-family: sans-serif;
  font-size: 0.85em;
  width: 100%;
  max-width: 290px;
}



    /* EOS */
  </style>

  <script id="insert"></script>

</head>
<body>
    <center><center>
  
  <div id="flag" style="font-size: 3em;"></div>
  <main id="laps"></main>
  <br><br><br>
  <br><br><br><br><br>
  <script src="https://stupid-fast.com/gviz.js"></script>
  <footer>
  <br>
      <details>
        <summary>Info</summary>

        Date: <input type="date" id="inpdate" onchange="getCurrentRace()">
        Race date: <input type="text" id="outputraceday" disabled>
        Race id: <input type="text" id="outputraceid" disabled>
        Track: <input type="text" id="outputrace" disabled>
      </details>
    <small>
      https://jsfiddle.net/schweissguth/vzkm5ra2/
    </small>
  </footer>
</center></center>








    <script type="text/javascript">//<![CDATA[


var SS = "1jwadkJYYfBmf-SbjUokDV0S_yzC7gD39-jHxVatJfLU"
var TODAY = Date.now()
var RACEID = 0




function init() {
  inpdate.valueAsDate = new Date()
  getRaceSchedule()
}

init()

function getRaceSchedule() {
  fetch("https://cf.nascar.com/cacher/2023/race_list_basic.json").then(function(x) {
    return x.json()
  }).then(function(item) {
    RACESCHEDULE = item.series_1.reverse()
    getCurrentRace()
  })
}

function getCurrentRace() {
	laps.innerHTML = ""
  var todaydate = new Date(inpdate.value + "T00:00:00-06:00")
  var todaytime = todaydate.getTime()
  console.log(todaytime)

  var race = RACESCHEDULE.find(function(item) {
    var datestr = new Date(item.date_scheduled).toLocaleDateString()
    var gettime = new Date(datestr).getTime()
    console.log(todaytime - gettime)
    return gettime < todaytime
  })

  outputraceid.value = race.race_id
  RACEID = race.race_id
  outputraceday.value = new Date(race.date_scheduled)
  outputrace.value = race.track_name

  getRaceFeed()
}



function getRaceFeed() {
  fetch("https://cf.nascar.com/cacher/2023/1/" + RACEID + "/lap-notes.json").then(function(x) {
    return x.text();
  }).then(function(y) {
    var arr = JSON.parse(y)
    console.log(arr)
    var keys = Object.keys(arr.laps)
    keys.forEach(function(item) {
      var p = document.createElement("P")
      p.innerHTML = "<b>Lap " + item + ": </b><br>" + arr.laps[item][0].Note + "<br><br>"
      laps.prepend(p)
    })
  })

  fetch("https://cf.nascar.com/live/feeds/live-flag-data.json").then(x => x.text()).then(function(result) {
    var parse = JSON.parse(result)
    //console.log(parse)
    var pop = parse.pop()
    //console.log(pop)

    switch (pop.flag_state) {
      case 8:
        flag.innerText = "🏴"
        break;

      case 1:
        flag.innerText = "🟢"
        break;

      case 2:
        flag.innerText = "🟡"
        break;

      case 4:
        flag.innerText = "🏁"
    }
  })
}



  //]]></script>

  <script>
    // tell the embed parent frame the height of the content
    if (window.parent && window.parent.parent){
      window.parent.parent.postMessage(["resultsFrame", {
        height: document.body.getBoundingClientRect().height,
        slug: "vzkm5ra2"
      }], "*")
    }

    // always overwrite window.name, in case users try to set it manually
    window.name = "result"
  </script>


</body>
</html>
